<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zylite Explorer</title>
<link rel="icon" type="image/png" href="Zylite_png.png" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs/loader.min.js"></script>

<style>
  :root{
    --bg: #0B1118;
    --sidebar-bg: #0B1118;
    --sidebar-border: #3A3A3A;
    --tab-active: #0098E2;
    --tab-inactive: #0B1118;
    --text: #E8EDF4;
    --muted: #334155;
    --accent: #0098E2;
    --accent-hover: #0098E2;
    --scrollbar-bg: #0F172A;
    --scrollbar-thumb: #1E293B;
    --scrollbar-thumb-hover: #334155;
  }

  html,body{ height:100%; margin:0; background:var(--bg); font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; }
  #app { display:flex; height:100vh; width:100vw; color:var(--text); box-sizing:border-box; }

  /* ─── Scrollbars ─── */
  ::-webkit-scrollbar { width:6px; height:6px; }
  ::-webkit-scrollbar-track { background:var(--scrollbar-bg); }
  ::-webkit-scrollbar-thumb { background:var(--scrollbar-thumb); border-radius:3px; }
  ::-webkit-scrollbar-thumb:hover { background:var(--scrollbar-thumb-hover); }
  * { scrollbar-width:thin; scrollbar-color:var(--scrollbar-thumb) var(--scrollbar-bg); }

  /* ─── Monaco #676aff nuclear kill ─── */
  .tab.active                { background:#0098E2 !important; border-color:#0098E2 !important; color:#fff !important; }
  .tab.active:hover          { background:#0098E2 !important; border-color:#0098E2 !important; }
  .tab:not(.active):hover    { background:rgba(0,152,226,0.12) !important; border-color:rgba(0,152,226,0.25) !important; color:#0098E2 !important; }

  .monaco-editor .suggest-widget .monaco-list .list-item.selected,
  .monaco-editor .suggest-widget .monaco-list .list-item.focused { background:rgba(0,152,226,0.2) !important; }
  .monaco-editor .suggest-widget .monaco-list .list-item.selected .label-name,
  .monaco-editor .suggest-widget .monaco-list .list-item.focused .label-name { color:#fff !important; }
  .monaco-editor .suggest-widget .detail-pane                   { border-left-color:#007AB5 !important; }

  .monaco-editor .find-widget input:focus,
  .monaco-editor .find-widget textarea:focus                    { border-color:#007AB5 !important; box-shadow:0 0 0 1px #007AB5 !important; }
  .monaco-editor .find-widget .toggle.checked                   { background:rgba(0,152,226,0.25) !important; border-color:#0098E2 !important; color:#fff !important; }
  .monaco-editor .find-widget .toggle.checked:hover             { background:rgba(0,152,226,0.4) !important; }
  .monaco-editor .find-widget .toggle:hover                     { border-color:rgba(0,152,226,0.4) !important; }
  .monaco-editor .find-widget .find-toggle-button.checked,
  .monaco-editor .find-widget .find-toggle-button:hover         { border-color:#0098E2 !important; }
  .monaco-editor .find-widget .input-group-input input          { border-color:#334155 !important; }
  .monaco-editor .find-widget .input-group-input input:focus    { border-color:#007AB5 !important; }
  .monaco-editor .find-widget .find-input .input-group-buttons .action-container .action-item:hover { background:rgba(0,152,226,0.15) !important; }

  .monaco-editor .quick-input-widget .quick-input-list .list-item.selected,
  .monaco-editor .quick-input-widget .quick-input-list .list-item.focused { background:rgba(0,152,226,0.2) !important; }
  .monaco-editor .quick-input-widget input:focus                { border-color:#007AB5 !important; box-shadow:0 0 0 1px #007AB5 !important; }

  .monaco-editor .action-item:hover                             { background:rgba(0,152,226,0.13) !important; }
  .monaco-editor .action-item.checked                           { color:#0098E2 !important; }
  .monaco-editor .action-item.checked .action-label             { color:#0098E2 !important; }
  .monaco-editor .action-item.separator                         { border-color:#1E293B !important; }

  .monaco-editor .breadcrumb-picker .focused-label .label-name  { color:#0098E2 !important; }
  .monaco-breadcrumb-item:hover                                 { color:#0098E2 !important; }

  .monaco-editor .minimap-cursor-layer .cursorBlock             { background:rgba(0,152,226,0.5) !important; }
  .monaco-editor .minimap-cursor-layer .cursorPixel             { background:rgba(0,152,226,0.5) !important; }

  .monaco-editor .parameter-hints-widget .signature-help-pane .parameterInfo { color:#E8EDF4 !important; }
  .monaco-editor .parameter-hints-widget .signature .parameter.active        { color:#0098E2 !important; font-weight:600; }

  .monaco-editor .badge                                         { background:#007AB5 !important; color:#fff !important; }
  .monaco-editor .monaco-badge span                             { background:#007AB5 !important; color:#fff !important; }

  .monaco-editor .code-action-widget .list-item.selected .action-label,
  .monaco-editor .code-action-widget .list-item.focused .action-label { color:#fff !important; }
  .monaco-editor .code-action-widget .list-item.selected,
  .monaco-editor .code-action-widget .list-item.focused        { background:rgba(0,152,226,0.2) !important; }
  .monaco-editor .code-action-widget .lightbulb-action-button:hover { background:rgba(0,152,226,0.15) !important; }

  .monaco-editor .hover-overlay-widget .markdown-hover .value  { color:#E8EDF4 !important; }
  .monaco-editor .hover-overlay-widget                         { border-color:#334155 !important; background:#0F172A !important; }

  .monaco-scrollable-element .scrollbar                        { background:#0F172A !important; }
  .monaco-scrollable-element .scrollbar .slider                { background:#1E293B !important; }
  .monaco-scrollable-element .scrollbar .slider:hover          { background:#334155 !important; }

  /* ─── Sidebar ─── */
  #sidebar {
    width:140px; min-width:140px; max-width:420px;
    background:var(--sidebar-bg);
    border-right:1px solid var(--sidebar-border);
    display:flex; flex-direction:column;
    padding:0; gap:10px;
    position:relative;
  }
  .sidebar-header { display:flex; align-items:center; gap:8px; font-size:14px; font-weight:600; color:var(--text); padding:12px; }
  .sidebar-header svg { width:18px; height:18px; color:var(--text); flex-shrink:0; }
  #file-actions { display:flex; gap:8px; align-items:center; margin-left:auto; margin-right:8px; }

  .btn-icon {
    background:transparent; border:1px solid rgba(255,255,255,0.08);
    color:var(--text); width:30px; height:30px; border-radius:6px;
    cursor:pointer; display:flex; align-items:center; justify-content:center;
    transition:background .15s, border-color .15s;
  }
  .btn-icon:hover { background:rgba(255,255,255,0.07); border-color:rgba(255,255,255,0.18); }
  .btn-icon.spinning svg { animation:spin .55s cubic-bezier(.4,0,.2,1) forwards; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .btn-icon svg { width:16px; height:16px; color:var(--text); }

  .files-list { flex:1; overflow-y:auto; padding:0 12px 0 0; display:flex; flex-direction:column; gap:4px; margin-top:4px; }
  .file-item {
    display:flex; justify-content:space-between; align-items:center;
    padding:8px 8px 8px 12px; border-radius:6px; cursor:pointer; font-size:13px; color:var(--text);
    transition:background .16s, transform .16s;
  }
  .file-item:hover { background:rgba(255,255,255,0.05); transform:translateX(4px); }
  .file-item .name { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1; margin-right:8px; }
  .file-item .file-icon { width:18px; height:18px; opacity:.85; flex-shrink:0; margin-right:8px; }
  .file-item .remove-file {
    width:16px; height:16px; opacity:.4; flex-shrink:0; cursor:pointer;
    transition:opacity .15s, color .15s;
  }
  .file-item .remove-file:hover { opacity:1; color:#ff4444; }

  /* ─── Right panel ─── */
  #right { flex:1; display:flex; flex-direction:column; height:100vh; min-width:300px; overflow:hidden; }

  /* ─── Tabs with drag support ─── */
  #tabs-bar {
    height:44px; display:flex; align-items:center; gap:4px;
    padding:6px 8px; background:transparent;
    border-bottom:1px solid rgba(255,255,255,0.06);
    overflow-x:auto; flex-shrink:0;
  }
  #tabs-bar::-webkit-scrollbar { height:0; }

  .tab {
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:5px;
    border:1px solid transparent;
    background:rgba(255,255,255,0.03);
    color:rgba(232,237,244,0.55);
    cursor:grab; white-space:nowrap; flex-shrink:0;
    transition:background .15s, color .15s, border-color .15s;
    opacity:0; animation:fadeIn .25s forwards;
    user-select:none;
    position:relative;
  }
  .tab.dragging {
    opacity:0.5;
    cursor:grabbing;
  }
  .tab.drag-over {
    border-left:2px solid #0098E2;
  }
  .tab:not(.active):hover {
    background:rgba(0,152,226,0.12);
    border-color:rgba(0,152,226,0.25);
    color:var(--accent-hover);
  }
  .tab.active {
    background:#0098E2;
    border-color:#0098E2;
    color:#fff;
  }
  .tab.active:hover { background:#0098E2; border-color:#0098E2; }

  .tab .label { font-size:13px; font-weight:600; max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .tab .close {
    display:flex; align-items:center; justify-content:center;
    width:20px; height:20px; border-radius:4px;
    cursor:pointer; opacity:.45; transition:opacity .15s, background .15s;
  }
  .tab .close:hover { opacity:1; background:rgba(255,255,255,0.12); }
  .tab .close svg { width:13px; height:13px; color:currentColor; }
  .tab.active .close svg { color:rgba(255,255,255,0.7); }

  /* Auto-save indicator */
  .tab .save-indicator {
    width:6px; height:6px; border-radius:50%;
    background:#4ade80;
    position:absolute; top:4px; right:4px;
    opacity:0; transition:opacity .3s;
  }
  .tab .save-indicator.saving {
    opacity:1;
    animation:pulse 1s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity:0.4; }
    50% { opacity:1; }
  }

  @keyframes fadeIn  { from { opacity:0; transform:translateY(-4px); } to { opacity:1; transform:none; } }
  @keyframes fadeOut { from { opacity:1; transform:none; } to { opacity:0; transform:translateY(-4px); } }

  #tab-add {
    margin-left:4px; background:transparent; border:none; cursor:pointer;
    padding:5px; border-radius:6px; display:flex; align-items:center; justify-content:center;
    color:rgba(232,237,244,0.35); transition:color .15s, background .15s; flex-shrink:0;
  }
  #tab-add:hover { color:var(--accent-hover); background:rgba(0,152,226,0.08); }
  #tab-add svg { width:18px; height:18px; }

  /* ─── Editor ─── */
  #editor-wrap { flex:1; position:relative; display:flex; min-height:0; overflow:hidden; }
  #editor { flex:1; height:100%; position:relative; }

  /* ─── Sidebar resizer ─── */
  #sidebar-resizer {
    position:absolute; top:0; right:0; width:6px; height:100%;
    cursor:col-resize; background:transparent; z-index:10; transition:background .15s;
  }
  #sidebar-resizer:hover { background:rgba(0,122,181,0.3); }

  @media (max-width:800px){ #sidebar{ width:140px; } }

  /* ══════════════════════════════════════
     CONTEXT MENU
     ══════════════════════════════════════ */
  #ctx-menu {
    position:fixed; z-index:9999;
    background:#1a2233; border:1px solid rgba(255,255,255,0.1);
    border-radius:8px; padding:6px; min-width:150px;
    box-shadow:0 8px 28px rgba(0,0,0,0.45);
    opacity:0; transform:scale(.94) translateY(-4px);
    transition:opacity .15s ease, transform .15s ease;
    pointer-events:none;
  }
  #ctx-menu.visible { opacity:1; transform:scale(1) translateY(0); pointer-events:auto; }

  .ctx-item {
    display:flex; align-items:center; gap:9px;
    padding:8px 12px; border-radius:6px;
    font-size:13px; color:var(--text); cursor:pointer;
    transition:background .12s;
    border:none; background:none; width:100%; text-align:left; font-family:inherit;
  }
  .ctx-item:hover { background:rgba(0,152,226,0.13); color:#fff; }
  .ctx-item svg { width:15px; height:15px; opacity:.7; flex-shrink:0; }
  .ctx-item:hover svg { opacity:1; }
  .ctx-sep { height:1px; background:rgba(255,255,255,0.07); margin:4px 8px; }

  /* ══════════════════════════════════════
     RENAME INPUT (inline on active tab)
     ══════════════════════════════════════ */
  .tab .label-input {
    font-size:13px; font-weight:600; max-width:120px; width:100px;
    background:rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.22);
    border-radius:3px; color:#fff; padding:1px 5px;
    outline:none; font-family:inherit; caret-color:var(--accent-hover);
  }
  .tab .label-input:focus { border-color:var(--accent-hover); }

  /* ══════════════════════════════════════
     TOAST NOTIFICATIONS
     ══════════════════════════════════════ */
  #toast-container {
    position:fixed; top:18px; right:18px; z-index:10000;
    display:flex; flex-direction:column; gap:8px; pointer-events:none;
  }
  .toast {
    display:flex; align-items:center; gap:10px;
    background:#1a2233; border:1px solid rgba(255,255,255,0.09);
    border-radius:10px; padding:10px 16px;
    box-shadow:0 4px 18px rgba(0,0,0,0.4);
    color:var(--text); font-size:13px; white-space:nowrap;
    pointer-events:auto;
    opacity:0; transform:translateX(60px) scale(.96);
    transition:opacity .28s cubic-bezier(.4,0,.2,1), transform .28s cubic-bezier(.4,0,.2,1);
  }
  .toast.show { opacity:1; transform:translateX(0) scale(1); }
  .toast.hide { opacity:0; transform:translateX(40px) scale(.96); }

  .toast-icon { width:20px; height:20px; border-radius:6px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
  .toast-icon svg { width:13px; height:13px; }
  .toast.add   .toast-icon { background:rgba(0,152,226,0.2); } .toast.add   .toast-icon svg { color:#0098E2; }
  .toast.del   .toast-icon { background:rgba(239,68,68,0.2); } .toast.del   .toast-icon svg { color:#ef4444; }
  .toast.rename .toast-icon { background:rgba(74,222,128,0.2); } .toast.rename .toast-icon svg { color:#4ade80; }
  .toast.save   .toast-icon { background:rgba(74,222,128,0.2); } .toast.save   .toast-icon svg { color:#4ade80; }

  .toast-text .toast-label { font-weight:600; color:#fff; }

  .toast-bar { position:absolute; bottom:0; left:0; height:2px; border-radius:0 0 10px 10px; width:100%; overflow:hidden; }
  .toast-bar-fill { height:100%; width:100%; border-radius:2px; animation:shrink var(--dur,2s) linear forwards; }
  .toast.add    .toast-bar-fill { background:var(--accent-hover); }
  .toast.del    .toast-bar-fill { background:#ef4444; }
  .toast.rename .toast-bar-fill { background:#4ade80; }
  .toast.save   .toast-bar-fill { background:#4ade80; }
  @keyframes shrink { from { width:100%; } to { width:0%; } }
  .toast { position:relative; overflow:hidden; }

  .sidebar-hint { font-size:12px; color:rgba(255,255,255,0.4); padding:4px 12px 12px 12px; line-height:1.5; }
  .sidebar-hint span { opacity:.7; }

  /* ─── Sidebar Footer Buttons ─── */
  .sidebar-footer {
    display:flex;
    gap:8px;
    padding:12px;
    border-top:1px solid rgba(255,255,255,0.06);
    background:rgba(0,0,0,0.1);
  }
  .btn-footer {
    flex:1;
    background:rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.08);
    color:var(--text);
    height:38px;
    border-radius:6px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:background .15s, border-color .15s, transform .1s;
  }
  .btn-footer:hover {
    background:rgba(0,152,226,0.12);
    border-color:rgba(0,152,226,0.3);
    transform:translateY(-1px);
  }
  .btn-footer:active {
    transform:translateY(0);
  }
  .btn-footer svg {
    width:18px;
    height:18px;
    color:var(--text);
  }
</style>
</head>
<body>
<div id="app">

  <!-- Sidebar -->
  <aside id="sidebar" role="navigation" aria-label="File Explorer">
    <div style="display:flex;align-items:center;gap:8px;">
      <div class="sidebar-header">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M20 5h-9.586L8.707 3.293A1 1 0 0 0 8 3H4c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h16c1.103 0 2-.897 2-2V7c0-1.103-.897-2-2-2"/></svg>
        <span>Scripts</span>
      </div>
      <div id="file-actions" style="margin-left:auto">
        <button id="btn-refresh" class="btn-icon" title="Refresh files" aria-label="Refresh files">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        </button>
      </div>
    </div>
    <div class="files-list" id="files-list" aria-live="polite"></div>
    <div class="sidebar-footer">
      <button class="btn-footer" id="btn-open" title="Open Script File">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
      </button>
      <button class="btn-footer" id="btn-save" title="Save Script to File">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
          <polyline points="17 21 17 13 7 13 7 21"/>
          <polyline points="7 3 7 8 15 8"/>
        </svg>
      </button>
    </div>
    <div id="sidebar-resizer" aria-hidden="true"></div>
  </aside>

  <!-- Right -->
  <div id="right">
    <div id="tabs-bar" role="tablist" aria-label="Editor Tabs">
      <button id="tab-add" title="New Tab" aria-label="New Tab">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-dasharray="16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M5 12h14"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="16;0"/></path><path stroke-dashoffset="16" d="M12 5v14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.5s" dur="0.5s" to="0"/></path></g></svg>
      </button>
    </div>
    <div id="editor-wrap"><div id="editor"></div></div>
  </div>
</div>

<!-- Context menu (shared) -->
<div id="ctx-menu">
  <button class="ctx-item" id="ctx-rename">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
    Rename
  </button>
  <button class="ctx-item" id="ctx-cancel">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
    Cancel
  </button>
</div>

<!-- Toast container -->
<div id="toast-container"></div>

<script>
(function(){
  /* ─── State ─── */
  const tabs = [];
  let activeTabId = null;
  let editor = null;
  let monacoIsReady = false;
  let ctxTargetTabId = null;
  let autoSaveTimer = null;
  let draggedTab = null;

  /* ─── DOM ─── */
  const tabsBar         = document.getElementById('tabs-bar');
  const tabAddBtn       = document.getElementById('tab-add');
  const filesList       = document.getElementById('files-list');
  const btnRefresh      = document.getElementById('btn-refresh');
  const editorContainer = document.getElementById('editor');
  const ctxMenu         = document.getElementById('ctx-menu');
  const ctxRename       = document.getElementById('ctx-rename');
  const ctxCancel       = document.getElementById('ctx-cancel');
  const toastContainer  = document.getElementById('toast-container');

  /* ═══════════════════ AUTO-SAVE ═══════════════════ */
  function scheduleAutoSave(){
    if(autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(()=>{
      saveAllTabs();
    }, 2000); // Auto-save after 2 seconds of inactivity
  }

  function saveAllTabs(){
    const activeTab = tabs.find(t=> t.id === activeTabId);
    if(!activeTab) return;
    
    // Save to localStorage
    const saveData = tabs.map(t=>({
      id: t.id,
      name: t.name,
      content: t.content,
      filename: t.filename
    }));
    
    try{
      localStorage.setItem('zylite_tabs', JSON.stringify(saveData));
      localStorage.setItem('zylite_active_tab', activeTabId);
      
      // Save loaded files list separately
      const loadedFiles = tabs.filter(t=> t.filename).map(t=>({
        id: t.id,
        filename: t.filename,
        name: t.name
      }));
      localStorage.setItem('zylite_loaded_files', JSON.stringify(loadedFiles));
      
      // Show save indicator briefly
      if(activeTab.element){
        const indicator = activeTab.element.querySelector('.save-indicator');
        if(indicator){
          indicator.classList.add('saving');
          setTimeout(()=> indicator.classList.remove('saving'), 1500);
        }
      }
      
      console.log('Auto-saved', saveData.length, 'tabs');
    } catch(e){
      console.error('Save failed:', e);
    }
  }

  function loadSavedTabs(){
    try{
      const saved = localStorage.getItem('zylite_tabs');
      const activeId = localStorage.getItem('zylite_active_tab');
      
      if(saved){
        const data = JSON.parse(saved);
        if(Array.isArray(data) && data.length > 0){
          // Clear initial tab
          tabs.length = 0;
          document.querySelectorAll('.tab').forEach(t=> t.remove());
          
          // Restore saved tabs
          data.forEach(tabData=>{
            createTab(tabData.content || '', tabData.filename, tabData.id, true);
          });
          
          // Restore active tab
          if(activeId){
            const targetTab = tabs.find(t=> t.id == activeId);
            if(targetTab) activateTab(targetTab.id);
          } else if(tabs.length > 0){
            activateTab(tabs[0].id);
          }
          
          // Restore loaded files list
          const loadedFilesData = localStorage.getItem('zylite_loaded_files');
          if(loadedFilesData){
            const loadedFiles = JSON.parse(loadedFilesData);
            loadedFiles.forEach(file=>{
              addFileToList(file.id, file.filename);
            });
          }
          
          showToast('save', 'Session restored');
          return true;
        }
      }
    } catch(e){
      console.error('Load failed:', e);
    }
    return false;
  }
  
  /* ═══════════════════ LOADED FILES LIST ═══════════════════ */
  function addFileToList(tabId, filename){
    // Check if already exists
    const existing = filesList.querySelector(`[data-tab-id="${tabId}"]`);
    if(existing) return;
    
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.dataset.tabId = tabId;
    fileItem.innerHTML = `
      <div class="name">${escapeHtml(filename)}</div>
      <svg class="file-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M13 9V3.5L18.5 9M6 2c-1.11 0-2 .89-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/></svg>
      <svg class="remove-file" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    `;
    
    // Click on name/icon to activate tab
    const nameEl = fileItem.querySelector('.name');
    const iconEl = fileItem.querySelector('.file-icon');
    const clickHandler = ()=> activateTab(tabId);
    nameEl.addEventListener('click', clickHandler);
    iconEl.addEventListener('click', clickHandler);
    
    // Click on X to remove from list (and close tab)
    const removeBtn = fileItem.querySelector('.remove-file');
    removeBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      fileItem.remove();
      closeTab(tabId, true);
    });
    
    filesList.appendChild(fileItem);
  }
  
  function removeFileFromList(tabId){
    const fileItem = filesList.querySelector(`[data-tab-id="${tabId}"]`);
    if(fileItem) fileItem.remove();
  }

  /* ═══════════════════ TOAST ═══════════════════ */
  function showToast(type, message, dur = 2200){
    const icons = {
      add:    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
      del:    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>',
      rename: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
      save:   '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',
      open:   '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
      error:  '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
    };
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.style.setProperty('--dur', dur + 'ms');
    t.innerHTML = `
      <div class="toast-icon">${icons[type] || icons.save}</div>
      <div class="toast-text"><span class="toast-label">${message}</span></div>
      <div class="toast-bar"><div class="toast-bar-fill"></div></div>`;
    toastContainer.appendChild(t);
    requestAnimationFrame(()=> requestAnimationFrame(()=> t.classList.add('show')));
    setTimeout(()=>{
      t.classList.remove('show');
      t.classList.add('hide');
      setTimeout(()=> t.remove(), 300);
    }, dur);
  }

  /* ═══════════════════ CONTEXT MENU ═══════════════════ */
  function hideCtxMenu(){ ctxMenu.classList.remove('visible'); ctxTargetTabId = null; }

  document.addEventListener('click', (e)=>{ if(!ctxMenu.contains(e.target)) hideCtxMenu(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hideCtxMenu(); });

  ctxCancel.addEventListener('click', ()=> hideCtxMenu());

  ctxRename.addEventListener('click', (e)=>{
    e.stopPropagation();
    e.stopImmediatePropagation();
    const targetId = ctxTargetTabId;
    hideCtxMenu();
    if (targetId === null) return;
    const t = tabs.find(x=> x.id === targetId);
    if (t) startRenaming(t);
  });

  /* ═══════════════════ HOST BRIDGE ═══════════════════ */
  function postToHost(obj){
    try{
      const json = typeof obj === 'string' ? obj : JSON.stringify(obj);
      if (window.chrome && window.chrome.webview && window.chrome.webview.postMessage)
        window.chrome.webview.postMessage(json);
      else { window.postMessage(obj,'*'); console.log('[postToHost mock]', obj); }
    } catch(e){ console.error(e); }
  }

  /* ═══════════════════ REFRESH ═══════════════════ */
  btnRefresh.addEventListener('click', ()=>{
    btnRefresh.classList.add('spinning');
    requestFileList();
    setTimeout(()=> btnRefresh.classList.remove('spinning'), 550);
  });

  /* ═══════════════════ TABS ═══════════════════ */
  function renumberTabsDOM(){
    for (let i=0; i<tabs.length; i++){
      const t = tabs[i];
      const label = t.filename || `Script ${i+1}`;
      t.name = label;
      if (t.element){
        const lbl = t.element.querySelector('.label');
        if (lbl) lbl.textContent = label;
      }
    }
  }

  function closeSvg(){
    return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="m12 13.4l-4.9 4.9q-.275.275-.7.275t-.7-.275t-.275-.7t.275-.7l4.9-4.9l-4.9-4.9q-.275-.275-.275-.7t.275-.7t.7-.275t.7.275l4.9 4.9l4.9-4.9q.275-.275.7-.275t.7.275t.275.7t-.275.7L13.4 12l4.9 4.9q.275.275.275.7t-.275.7t-.7.275t-.7-.275z"/></svg>';
  }

  function createTab(initialContent='', filename=null, forceId=null, skipToast=false){
    const id = forceId || (Date.now() + Math.floor(Math.random()*1000));
    const tabObj = { id, name:null, content:initialContent, element:null, filename:filename||null };
    tabs.push(tabObj);
    renumberTabsDOM();

    const tabEl = document.createElement('div');
    tabEl.className = 'tab';
    tabEl.dataset.id = id;
    tabEl.draggable = true;
    tabEl.innerHTML  = `<div class="label"></div><div class="save-indicator"></div><div class="close" title="Close" aria-label="Close tab">${closeSvg()}</div>`;
    tabsBar.insertBefore(tabEl, tabAddBtn);
    tabObj.element = tabEl;

    /* click → activate or close */
    tabEl.addEventListener('click', (e)=>{
      if (e.target.closest('.close')){ closeTab(id,true); return; }
      activateTab(id);
    });

    /* right-click → context menu */
    tabEl.addEventListener('contextmenu', (e)=>{
      e.preventDefault();
      e.stopPropagation();
      ctxMenu.classList.remove('visible');
      ctxTargetTabId = id;
      const rect = tabEl.getBoundingClientRect();
      ctxMenu.style.left = rect.left + 'px';
      ctxMenu.style.top  = rect.bottom + 4 + 'px';
      requestAnimationFrame(()=> ctxMenu.classList.add('visible'));
    });

    /* ─── DRAG AND DROP ─── */
    tabEl.addEventListener('dragstart', (e)=>{
      draggedTab = tabObj;
      tabEl.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', tabEl.innerHTML);
    });

    tabEl.addEventListener('dragend', ()=>{
      tabEl.classList.remove('dragging');
      document.querySelectorAll('.tab').forEach(t=> t.classList.remove('drag-over'));
      draggedTab = null;
    });

    tabEl.addEventListener('dragover', (e)=>{
      if(!draggedTab || draggedTab.id === tabObj.id) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      const rect = tabEl.getBoundingClientRect();
      const midpoint = rect.left + rect.width / 2;
      
      document.querySelectorAll('.tab').forEach(t=> t.classList.remove('drag-over'));
      tabEl.classList.add('drag-over');
    });

    tabEl.addEventListener('drop', (e)=>{
      e.preventDefault();
      if(!draggedTab || draggedTab.id === tabObj.id) return;
      
      const draggedIdx = tabs.findIndex(t=> t.id === draggedTab.id);
      const targetIdx = tabs.findIndex(t=> t.id === tabObj.id);
      
      if(draggedIdx !== -1 && targetIdx !== -1){
        // Reorder tabs array
        tabs.splice(draggedIdx, 1);
        const newTargetIdx = tabs.findIndex(t=> t.id === tabObj.id);
        tabs.splice(newTargetIdx, 0, draggedTab);
        
        // Reorder DOM
        const allTabs = Array.from(tabsBar.querySelectorAll('.tab'));
        allTabs.forEach(t=> t.remove());
        tabs.forEach(t=> tabsBar.insertBefore(t.element, tabAddBtn));
        
        scheduleAutoSave();
      }
      
      document.querySelectorAll('.tab').forEach(t=> t.classList.remove('drag-over'));
    });

    renumberTabsDOM();
    activateTab(id);
    if (monacoIsReady && editor) editor.setValue(initialContent||'');

    if(!skipToast) showToast('add', `Created "${tabObj.name}"`);
    return tabObj;
  }

  /* ─── Rename ─── */
  function startRenaming(tabObj){
    const labelEl = tabObj.element.querySelector('.label');
    if (!labelEl) return;
    const oldName = labelEl.textContent;

    const input = document.createElement('input');
    input.className  = 'label-input';
    input.value      = oldName;
    input.spellcheck = false;
    labelEl.replaceWith(input);
    input.focus();
    input.select();

    function commit(){
      const val = input.value.trim();
      const newLabel = document.createElement('div');
      newLabel.className  = 'label';
      newLabel.textContent = val || oldName;
      input.replaceWith(newLabel);

      if (val && val !== oldName){
        tabObj.filename = val;
        tabObj.name     = val;
        showToast('rename', `Renamed to "${val}"`);
        scheduleAutoSave();
      }
      renumberTabsDOM();
    }

    input.addEventListener('blur', commit);
    input.addEventListener('keydown', (e)=>{
      if (e.key==='Enter')  { e.preventDefault(); input.blur(); }
      if (e.key==='Escape') { input.value = oldName; input.blur(); }
    });
  }

  function activateTab(id){
    if (activeTabId===id) return;
    document.querySelectorAll('.tab').forEach(t=> t.classList.remove('active'));
    const tObj = tabs.find(x=> x.id===id);
    if (!tObj) return;
    if (tObj.element) tObj.element.classList.add('active');
    activeTabId = id;
    if (monacoIsReady && editor){ 
      editor.setValue(tObj.content||''); 
      editor.focus(); 
    }
    scheduleAutoSave();
  }

  function closeTab(id, removeFromArray=true){
    const idx = tabs.findIndex(t=> t.id===id);
    if (idx===-1) return;
    const tabObj = tabs[idx];
    const wasName = tabObj.name || 'Tab';

    if (tabObj.element){
      tabObj.element.style.animation = 'fadeOut .22s forwards';
      setTimeout(()=>{ if(tabObj.element && tabObj.element.parentNode) tabObj.element.parentNode.removeChild(tabObj.element); }, 220);
    }
    if (removeFromArray) tabs.splice(idx,1);
    
    // Remove from file list if it was a loaded file
    if(tabObj.filename){
      removeFileFromList(id);
    }

    showToast('del', `Closed "${wasName}"`);
    scheduleAutoSave();

    if (activeTabId===id){
      if (tabs.length>0){
        setTimeout(()=> activateTab(tabs[Math.max(0,idx-1)].id), 230);
      } else {
        setTimeout(()=> createTab(''), 230);
      }
    } else { renumberTabsDOM(); }
  }

  tabAddBtn.addEventListener('click', ()=> createTab(''));

  /* ═══════════════════ EXPLORER ═══════════════════ */
  function renderFileList(files){
    filesList.innerHTML='';
    if(!files||files.length===0){
      const p=document.createElement('div'); 
      p.style.cssText='color:rgba(255,255,255,0.3);font-size:13px;padding:8px;'; 
      p.textContent='No files found'; 
      filesList.appendChild(p); 
      return;
    }
    files.forEach(f=>{
      const it=document.createElement('div'); it.className='file-item';
      it.innerHTML=`<div class="name">${escapeHtml(f)}</div><div class="icon">${docSvg()}</div>`;
      it.addEventListener('click',()=> postToHost({command:'openFile',payload:f}));
      filesList.appendChild(it);
    });
  }
  function requestFileList(){ postToHost({command:'requestFiles',payload:''}); }

  /* ═══════════════════ HOST→JS BRIDGE ═══════════════════ */
  window.openFileInEditor = function(content, filename){
    const t = tabs.find(x=> x.id===activeTabId);
    if(!t){ 
      const nt=createTab(content,filename); 
      nt.content=content||''; 
      if(filename){
        nt.filename=filename;
        renumberTabsDOM();
      } 
      activateTab(nt.id); 
      return; 
    }
    t.content=content||'';
    if(filename) t.filename=filename;
    renumberTabsDOM();
    if(monacoIsReady && editor) editor.setValue(t.content);
    scheduleAutoSave();
  };
  window.setEditorContentFromHost = function(c,f){ window.openFileInEditor(c,f); };

  if(window.chrome && window.chrome.webview && window.chrome.webview.addEventListener){
    window.chrome.webview.addEventListener('message',(ev)=>{
      try{
        let data=ev.data;
        if(typeof data==='string'){try{data=JSON.parse(data);}catch(e){}}
        if(!data) return;
        if(data.type==='fileList'&&Array.isArray(data.files))          renderFileList(data.files);
        else if(data.type==='fileContent')                             window.openFileInEditor(data.content||'',data.fileName||data.filename||null);
        else if(data.command==='fileList'&&Array.isArray(data.payload)) renderFileList(data.payload);
        else if(data.command==='sendFile')                             window.openFileInEditor(data.payload||'',data.name||null);
      }catch(err){console.error(err);}
    });
  } else {
    window.addEventListener('message',(ev)=>{
      try{ 
        const d=ev.data; 
        if(!d)return; 
        if(d.type==='fileList')renderFileList(d.files||[]); 
        if(d.type==='fileContent')window.openFileInEditor(d.content||'',d.fileName||d.filename||null); 
      }catch(e){console.error(e);}
    });
  }

  /* ═══════════════════ MONACO ═══════════════════ */
  require.config({ paths:{ 'vs':'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs' }});
  require(['vs/editor/editor.main'], function(){
    monaco.editor.defineTheme('CustomTheme',{
      base:'vs-dark', inherit:true,
      rules:[
        {token:'',              foreground:'E8EDF4'},
        {token:'delimiter',     foreground:'808080'},
        {token:'operator',      foreground:'569CD6'},
        {token:'keyword',       foreground:'569CD6', fontStyle:'bold'},
        {token:'function',      foreground:'4EC9B0'},
        {token:'support.function', foreground:'4EC9B0'},
        {token:'string',        foreground:'9CDCFE'},
        {token:'number',        foreground:'B5CEA8'},
        {token:'comment',       foreground:'6A9955', fontStyle:'italic'}
      ],
      colors:{
        'editor.background':'#0B1118',
        'editor.foreground':'#E8EDF4',
        'editorLineNumber.foreground':'#334155',
        'editorLineNumber.activeForeground':'#007AB5',
        'editorIndentGuide.background':'#1E293B',
        'editorCursor.foreground':'#007AB5',
        'editorSuggestWidget.background':'#0F172A',
        'editorSuggestWidget.border':'#007AB5',
        'editorSuggestWidget.selectedBackground':'rgba(0,152,226,0.18)',
        'scrollbarSlider.background':'#1E293B',
        'scrollbarSlider.hoverBackground':'#334155',
        'scrollbarSlider.activeBackground':'#475569',
        'button.background':'#0098E2',
        'button.hoverBackground':'#0098E2',
        'button.foreground':'#FFFFFF',
        'badge.background':'#0098E2',
        'badge.foreground':'#FFFFFF',
        'activityBar.activeBorder':'#0098E2',
        'activityBarBadge.background':'#0098E2',
        'editorWidget.border':'#0098E2',
        'progressBar.background':'#0098E2',
        'focusBorder':'#0098E2',
        'selection.background':'rgba(0,152,226,0.25)',
        'input.background':'#0F172A',
        'input.border':'#0098E2',
        'inputOption.activeBackground':'rgba(0,152,226,0.2)',
        'inputOption.activeBorder':'#0098E2',
        'inputOption.activeForeground':'#FFFFFF',
        'inputValidation.infoBorder':'#0098E2',
        'inputValidation.infoBackground':'rgba(0,152,226,0.1)',
        'breadcrumb.activeColor':'#0098E2',
        'breadcrumbs.activeColor':'#0098E2'
      }
    });

    editor = monaco.editor.create(editorContainer,{
      value:'', language:'lua', theme:'CustomTheme',
      fontSize:13, fontFamily:"'Fira Code', monospace",
      minimap:{enabled:true}, automaticLayout:true,
      glyphMargin:true, folding:true, scrollBeyondLastLine:false,
      lightbulb:{enabled:true}
    });

    monaco.languages.registerCompletionItemProvider('lua',{
      provideCompletionItems:function(){
        return{suggestions:[
          {label:'print',   kind:monaco.languages.CompletionItemKind.Function, insertText:'print(${1:msg})',        insertTextRules:monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation:'Prints to console.'},
          {label:'wait',    kind:monaco.languages.CompletionItemKind.Function, insertText:'wait(${1:seconds})',    insertTextRules:monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, documentation:'Yield for seconds.'},
          {label:'require', kind:monaco.languages.CompletionItemKind.Function, insertText:'require("${1:module}")',insertTextRules:monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet},
          {label:'pairs',   kind:monaco.languages.CompletionItemKind.Function, insertText:'pairs(${1:tbl})',       insertTextRules:monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet},
          {label:'ipairs',  kind:monaco.languages.CompletionItemKind.Function, insertText:'ipairs(${1:tbl})',      insertTextRules:monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet},
          {label:'tonumber',kind:monaco.languages.CompletionItemKind.Function, insertText:'tonumber(${1:val})',   insertTextRules:monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet}
        ]};
      }
    });

    editor.onDidChangeModelContent(()=>{
      const t=tabs.find(x=> x.id===activeTabId);
      if(t){
        t.content=editor.getValue();
        scheduleAutoSave();
      }
    });

    monacoIsReady = true;
    
    // Try to load saved session
    const restored = loadSavedTabs();
    
    if(!restored){
      // Create initial tab if nothing was restored
      const id = Date.now();
      const tabObj = { id, name:'Script 1', content:'-- Welcome to Zylite\nprint("Zylite on top")\n', element:null, filename:null };
      tabs.push(tabObj);
      const tabEl = document.createElement('div');
      tabEl.className='tab active'; 
      tabEl.dataset.id=id;
      tabEl.draggable=true;
      tabEl.innerHTML=`<div class="label">Script 1</div><div class="save-indicator"></div><div class="close" title="Close" aria-label="Close tab">${closeSvg()}</div>`;
      tabsBar.insertBefore(tabEl, tabAddBtn);
      tabObj.element = tabEl;
      activeTabId = id;
      
      // Add event listeners for initial tab
      tabEl.addEventListener('click',(e)=>{ 
        if(e.target.closest('.close')){closeTab(id,true);return;} 
        activateTab(id); 
      });
      tabEl.addEventListener('contextmenu',(e)=>{ 
        e.preventDefault(); 
        e.stopPropagation(); 
        ctxMenu.classList.remove('visible'); 
        ctxTargetTabId=id; 
        const r=tabEl.getBoundingClientRect(); 
        ctxMenu.style.left=r.left+'px'; 
        ctxMenu.style.top=r.bottom+4+'px'; 
        requestAnimationFrame(()=>ctxMenu.classList.add('visible')); 
      });
      
      // Add drag listeners to initial tab
      tabEl.addEventListener('dragstart', (e)=>{
        draggedTab = tabObj;
        tabEl.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });
      tabEl.addEventListener('dragend', ()=>{
        tabEl.classList.remove('dragging');
        document.querySelectorAll('.tab').forEach(t=> t.classList.remove('drag-over'));
        draggedTab = null;
      });
      tabEl.addEventListener('dragover', (e)=>{
        if(!draggedTab || draggedTab.id === tabObj.id) return;
        e.preventDefault();
        tabEl.classList.add('drag-over');
      });
      tabEl.addEventListener('drop', (e)=>{
        e.preventDefault();
        if(!draggedTab || draggedTab.id === tabObj.id) return;
        const draggedIdx = tabs.findIndex(t=> t.id === draggedTab.id);
        const targetIdx = tabs.findIndex(t=> t.id === tabObj.id);
        if(draggedIdx !== -1 && targetIdx !== -1){
          tabs.splice(draggedIdx, 1);
          const newTargetIdx = tabs.findIndex(t=> t.id === tabObj.id);
          tabs.splice(newTargetIdx, 0, draggedTab);
          const allTabs = Array.from(tabsBar.querySelectorAll('.tab'));
          allTabs.forEach(t=> t.remove());
          tabs.forEach(t=> tabsBar.insertBefore(t.element, tabAddBtn));
          scheduleAutoSave();
        }
        document.querySelectorAll('.tab').forEach(t=> t.classList.remove('drag-over'));
      });
      
      editor.setValue(tabObj.content);
    }
    
    const current = tabs.find(x=> x.id===activeTabId);
    if(current) editor.setValue(current.content||'');
    
    requestFileList();
  });

  /* ─── Utility ─── */
  function docSvg(){ return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M13 9V3.5L18.5 9M6 2c-1.11 0-2 .89-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/></svg>'; }
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  window.updateFileList          = function(files){try{renderFileList(Array.isArray(files)?files:[]);}catch(e){console.error(e);}};
  window.sendFileContentToEditor = function(c,f){window.openFileInEditor(c,f);};
  window.requestFilesFromHost    = requestFileList;

  /* Ctrl/Cmd+S - Manual save */
  window.addEventListener('keydown',(e)=>{
    const mac=navigator.platform.toUpperCase().indexOf('MAC')>=0;
    if((mac?e.metaKey:e.ctrlKey)&&e.key.toLowerCase()==='s'){ 
      e.preventDefault(); 
      saveAllTabs();
      showToast('save', 'Saved manually');
    }
  });

  /* ─── Sidebar resize ─── */
  (function(){
    const sidebar=document.getElementById('sidebar');
    const resizer=document.getElementById('sidebar-resizer');
    let dragging=false;
    resizer.addEventListener('mousedown',(e)=>{ 
      e.preventDefault(); 
      dragging=true; 
      document.body.style.cursor='col-resize'; 
      document.body.style.userSelect='none'; 
    });
    window.addEventListener('mousemove',(e)=>{ 
      if(!dragging)return; 
      const newWidth = Math.min(420,Math.max(140,e.clientX));
      sidebar.style.width = newWidth+'px'; 
    });
    window.addEventListener('mouseup',()=>{ 
      if(!dragging)return; 
      dragging=false; 
      document.body.style.cursor=''; 
      document.body.style.userSelect=''; 
    });
  })();

  /* Auto-save on page unload */
  window.addEventListener('beforeunload', ()=>{
    saveAllTabs();
  });

  /* ─── Open Script File ─── */
  document.getElementById('btn-open').addEventListener('click', ()=>{
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.lua,.txt';
    input.onchange = (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      
      const reader = new FileReader();
      reader.onload = (event)=>{
        const content = event.target.result;
        const filename = file.name;
        
        // Create new tab with loaded content
        const id = Date.now();
        const tabObj = {
          id,
          name: filename.replace(/\.[^/.]+$/, ''), // Remove extension
          content: content,
          element: null,
          filename: filename
        };
        tabs.push(tabObj);
        
        const tabEl = document.createElement('div');
        tabEl.className = 'tab';
        tabEl.dataset.id = id;
        tabEl.draggable = true;
        tabEl.innerHTML = `<div class="label">${escapeHtml(tabObj.name)}</div><div class="save-indicator"></div><div class="close" title="Close" aria-label="Close tab">${closeSvg()}</div>`;
        tabsBar.insertBefore(tabEl, tabAddBtn);
        tabObj.element = tabEl;
        
        // Add event listeners
        tabEl.addEventListener('click', (e)=>{
          if(e.target.closest('.close')){
            closeTab(id, true);
            return;
          }
          activateTab(id);
        });
        tabEl.addEventListener('contextmenu', (e)=>{
          e.preventDefault();
          e.stopPropagation();
          ctxMenu.classList.remove('visible');
          ctxTargetTabId = id;
          const r = tabEl.getBoundingClientRect();
          ctxMenu.style.left = r.left + 'px';
          ctxMenu.style.top = r.bottom + 4 + 'px';
          requestAnimationFrame(()=> ctxMenu.classList.add('visible'));
        });
        
        // Add drag listeners
        tabEl.addEventListener('dragstart', (e)=>{
          draggedTab = tabObj;
          tabEl.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });
        tabEl.addEventListener('dragend', ()=>{
          tabEl.classList.remove('dragging');
          document.querySelectorAll('.tab').forEach(t=> t.classList.remove('drag-over'));
          draggedTab = null;
        });
        tabEl.addEventListener('dragover', (e)=>{
          if(!draggedTab || draggedTab.id === tabObj.id) return;
          e.preventDefault();
          tabEl.classList.add('drag-over');
        });
        tabEl.addEventListener('drop', (e)=>{
          e.preventDefault();
          if(!draggedTab || draggedTab.id === tabObj.id) return;
          const draggedIdx = tabs.findIndex(t=> t.id === draggedTab.id);
          const targetIdx = tabs.findIndex(t=> t.id === tabObj.id);
          if(draggedIdx !== -1 && targetIdx !== -1){
            tabs.splice(draggedIdx, 1);
            const newTargetIdx = tabs.findIndex(t=> t.id === tabObj.id);
            tabs.splice(newTargetIdx, 0, draggedTab);
            const allTabs = Array.from(tabsBar.querySelectorAll('.tab'));
            allTabs.forEach(t=> t.remove());
            tabs.forEach(t=> tabsBar.insertBefore(t.element, tabAddBtn));
            scheduleAutoSave();
          }
          document.querySelectorAll('.tab').forEach(t=> t.classList.remove('drag-over'));
        });
        
        // Activate the new tab
        activateTab(id);
        
        // Add to file list with remove button
        addFileToList(id, filename);
        
        showToast('save', `Opened ${filename}`);
        scheduleAutoSave();
      };
      reader.readAsText(file);
    };
    input.click();
  });

  /* ─── Save Script File ─── */
  document.getElementById('btn-save').addEventListener('click', ()=>{
    const currentTab = tabs.find(t=> t.id === activeTabId);
    if(!currentTab){
      showToast('error', 'No active script to save');
      return;
    }
    
    const content = currentTab.content || '';
    const filename = currentTab.filename || `${currentTab.name}.lua`;
    
    // Create blob and download
    const blob = new Blob([content], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('save', `Saved ${filename}`);
  });

})();
</script>
</body>
</html>
